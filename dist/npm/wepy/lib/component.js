"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function getEventsFn(t,e){var i=t.events?t.events[e]:void 0,n=void 0===i?"undefined":_typeof(i),o=void 0;if("string"===n){var a=t.methods&&t.methods[i];"function"==typeof a&&(o=a)}else"function"===n&&(o=i);return o}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_event=require("./event.js"),_event2=_interopRequireDefault(_event),_util=require("./util.js"),_util2=_interopRequireDefault(_util),Props={check:function(t,e){switch(t){case String:return"string"==typeof e;case Number:return"number"==typeof e;case Boolean:return"boolean"==typeof e;case Function:return"function"==typeof e;case Object:return"object"===(void 0===e?"undefined":_typeof(e));case Array:return"[object Array]"===toString.call(e);default:return e instanceof t}},build:function(t){var e={};return"string"==typeof t?e[t]={}:"[object Array]"===toString.call(t)?t.forEach(function(t){e[t]={}}):Object.keys(t).forEach(function(i){"function"==typeof t[i]?e[i]={type:[t[i]]}:"[object Array]"===toString.call(t[i])?e[i]={type:t[i]}:e[i]=t[i],e[i].type&&"[object Array]"!==toString.call(e[i].type)&&(e[i].type=[e[i].type])}),e},valid:function(t,e,i){var n=this,o=!1;if(t[e]){if(t[e].type)return t[e].type.some(function(t){return n.check(t,i)});o=!0}return o},getValue:function(t,e,i){var n;return n=void 0!==i&&this.valid(t,e,i)?i:"function"==typeof t[e].default?t[e].default():t[e].default,t[e].coerce?t[e].coerce(n):n}},_class=function(){function t(){_classCallCheck(this,t),this.$com={},this.$mixins=[],this.$isComponent=!0,this.$prefix="",this.$mappingProps={},this.data={},this.methods={}}return _createClass(t,[{key:"init",value:function(t,e,i){var n=this;this.$wxpage=t,this.$isComponent&&(this.$root=e||this.$root,this.$parent=i||this.$parent,this.$wxapp=this.$root.$parent.$wxapp),this.props&&(this.props=Props.build(this.props));var o=void 0,a={},r=this.props,s=void 0,p=void 0,f=void 0,u=!1,h=void 0;if(this.$props)for(s in this.$props)for(f in this.$props[s])/\.sync$/.test(f)&&(this.$mappingProps[this.$props[s][f]]||(this.$mappingProps[this.$props[s][f]]={}),this.$mappingProps[this.$props[s][f]][s]=f.substring(7,f.length-5));if(r)for(s in r)p=void 0,i&&i.$props&&i.$props[this.$name]&&(p=i.$props[this.$name][s],(f=i.$props[this.$name]["v-bind:"+s+".once"]||i.$props[this.$name]["v-bind:"+s+".sync"])&&("object"===(void 0===f?"undefined":_typeof(f))?function(){r[s].repeat=f.for,u=!0;var t=f.for,e=i;t.split(".").forEach(function(t){e=e[t]}),h=Object.keys(e)[0],n.$mappingProps[s]||(n.$mappingProps[s]={}),n.$mappingProps[s].parent={mapping:f.for,from:s}}():(p=i[f],r[s].twoWay&&(this.$mappingProps[s]||(this.$mappingProps[s]={}),this.$mappingProps[s].parent=f)))),this.data[s]||r[s].repeat||(p=Props.getValue(r,s,p),this.data[s]=p);for(o in this.data)a[""+this.$prefix+o]=this.data[o],this[o]=this.data[o];if(this.$data=_util2.default.$copy(this.data,!0),u&&this.$setIndex(h),this.computed)for(o in this.computed){var c=this.computed[o];a[""+this.$prefix+o]=c.call(this),this[o]=_util2.default.$copy(a[""+this.$prefix+o],!0)}this.setData(a);var $=Object.getOwnPropertyNames(this.$com);$.length&&$.forEach(function(t){n.$com[t].init(n.getWxPage(),e,n),n.$com[t].onLoad&&n.$com[t].onLoad(),n.$com[t].$apply()})}},{key:"initMixins",value:function(){var t=this;this.mixins?"function"==typeof this.mixins&&(this.mixins=[this.mixins]):this.mixins=[],this.mixins.forEach(function(e){var i=new e;i.init(t),t.$mixins.push(i)})}},{key:"onLoad",value:function(){}},{key:"setData",value:function(t,e){if("string"==typeof t){if(e){var i={};i[t]=e,t=i}else{var n={};n[t]=this.data[""+t],t=n}return this.$wxpage.setData(t)}var o=null,a=new RegExp("^"+this.$prefix.replace(/\$/g,"\\$"),"ig");for(o in t){var r=o.replace(a,"");this.$data[r]=_util2.default.$copy(t[o],!0)}return this.$wxpage.setData(t)}},{key:"getWxPage",value:function(){return this.$wxpage}},{key:"getCurrentPages",value:function(){return this.$wxpage.getCurrentPages()}},{key:"$setIndex",value:function(t){var e=this;if(this.$index!==t){this.$index=t;var i=this.props,n=this.$parent,o=void 0,a=void 0,r=void 0;if(i){for(o in i)a=void 0,n&&n.$props&&n.$props[this.$name]&&(a=n.$props[this.$name][o],(r=n.$props[this.$name]["v-bind:"+o+".once"]||n.$props[this.$name]["v-bind:"+o+".sync"])&&"object"===(void 0===r?"undefined":_typeof(r))&&function(){var i=r.for,s=n;i.split(".").forEach(function(t){s=s[t]}),a=s[t],e.$index=t,e.data[o]=a,e[o]=a,e.$data[o]=_util2.default.$copy(e[o],!0)}());for(o in this.$com)this.$com[o].$index=void 0}}}},{key:"$getComponent",value:function(t){var e=this;if("string"==typeof t){if(-1===t.indexOf("/"))return this.$com[t];if("/"===t)return this.$parent;t.split("/").forEach(function(i,n){0===n?t=""===i?e.$root:"."===i?e:".."===i?e.$parent:e.$getComponent(i):i&&(t=t.$com[i])})}return"object"!==(void 0===t?"undefined":_typeof(t))?null:t}},{key:"$invoke",value:function(t,e){if(!(t=this.$getComponent(t)))throw new Error("Invalid path: "+t);for(var i=t.methods?t.methods[e]:"",n=arguments.length,o=Array(n>2?n-2:0),a=2;a<n;a++)o[a-2]=arguments[a];if("function"==typeof i){var r=new _event2.default("",this,"invoke"),s=i.apply(t,o.concat(r));return t.$apply(),s}if("function"==typeof(i=t[e]))return i.apply(t,o);throw new Error("Invalid method: "+e)}},{key:"$broadcast",value:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];for(var o=this,a="string"==typeof t?new _event2.default(t,this,"broadcast"):a,r=[o];r.length&&a.active;){var s=r.shift();for(var p in s.$com){if("break"===function(e){e=s.$com[e],r.push(e);var n=getEventsFn(e,t);if(n&&e.$apply(function(){n.apply(e,i.concat(a))}),!a.active)return"break";p=e}(p))break}}}},{key:"$emit",value:function(t){for(var e=this,i=arguments.length,n=Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];var a=this,r=this,s=new _event2.default(t,r,"emit");if(void 0===this.$parent&&console.log(this),this.$parent.$events&&this.$parent.$events[this.$name]){var p=this.$parent.$events[this.$name]["v-on:"+t];if(p&&this.$parent.methods){var f=this.$parent.methods[p];if("function"==typeof f)return void this.$parent.$apply(function(){f.apply(e.$parent,n.concat(s))});throw new Error("Invalid method from emit, component is "+this.$parent.$name+", method is "+p+". Make sure you defined it already.\n")}}for(;a&&void 0!==a.$isComponent&&s.active;)!function(){var e=a,i=getEventsFn(e,t);i&&e.$apply(function(){i.apply(e,n.concat(s))}),a=e.$parent}()}},{key:"$apply",value:function(t){"function"==typeof t?(t.call(this),this.$apply()):this.$$phase?this.$$phase="$apply":this.$digest()}},{key:"$digest",value:function(){var t=this,e=void 0,i=this.$data;for(this.$$phase="$digest";this.$$phase;){var n={};for(e in i)_util2.default.$isEqual(this[e],i[e])||(n[this.$prefix+e]=this[e],this.data[e]=this[e],i[e]=_util2.default.$copy(this[e],!0),this.$mappingProps[e]&&Object.keys(this.$mappingProps[e]).forEach(function(i){var n=t.$mappingProps[e][i];"object"===(void 0===n?"undefined":_typeof(n))?t.$parent.$apply():"parent"!==i||_util2.default.$isEqual(t.$parent.$data[n],t[e])?"parent"===i||_util2.default.$isEqual(t.$com[i].$data[n],t[e])||(t.$com[i][n]=t[e],t.$com[i].data[n]=t[e],t.$com[i].$apply()):(t.$parent[n]=t[e],t.$parent.data[n]=t[e],t.$parent.$apply())}));if(Object.keys(n).length){if(this.computed)for(e in this.computed){var o=this.computed[e],a=o.call(this);_util2.default.$isEqual(this[e],a)||(n[this.$prefix+e]=a,this[e]=_util2.default.$copy(a,!0))}this.setData(n)}this.$$phase="$apply"===this.$$phase&&"$digest"}}}]),t}();exports.default=_class;